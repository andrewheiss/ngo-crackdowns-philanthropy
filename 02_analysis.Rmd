---
title: "Results"
author: "Andrew Heiss and Suparna Chaudhry"
date: "Last run: `r format(Sys.time(), '%B %e, %Y')`"
output: 
  html_document:
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r load-libraries-data, warning=FALSE, message=FALSE}
library(tidyverse)
library(rstanarm)
library(broom)
library(coda)
library(ggstance)
library(patchwork)
library(pander)
library(scales)
library(skimr)
library(janitor)
library(huxtable)
library(here)

source(file.path(here(), "lib", "graphics.R"))
source(file.path(here(), "lib", "pander_options.R"))
source(file.path(here(), "lib", "modeling.R"))

# Load data
results <- readRDS(file.path(here(), "data", "results_clean.rds"))


# Helpful functions
safe_mean <- function(x, ...) suppressWarnings(mean(as.numeric(x), ...))
safe_sd <- function(x, ...) suppressWarnings(sd(as.numeric(x), ...))

my_as_numeric <- function(x) {
  is_num <- suppressWarnings(!any(is.na(as.numeric(x))))
  
  if (is_num) {
    as.numeric(x)
  } else {
    x
  }
}

level_summary <- function(x, variable, df = results) {
  variable <- as.character(variable)
  if (is.factor(df[[variable]])) {
    x_levels <- levels(df[[variable]])
  } else {
    x_levels <- unique(df[[variable]])
  }
  
  data_frame(x) %>% 
    count(x) %>%
    mutate(pct = n / sum(n),
           fancy = paste0(x, " (", n, "; ", percent(pct), ")"),
           x = factor(x, levels = x_levels, ordered = TRUE)) %>% 
    arrange(x) %>% 
    pull(fancy) %>% 
    paste(collapse = " | ")
}

numeric_summary <- function(x) {
  paste0("Mean: ", round(mean(x, na.rm = TRUE), 2), 
         " | Std. Dev.: ", round(sd(x, na.rm = TRUE), 2),
         " | ", inline_hist(x))
}

my_summary <- function(x, variable, df) {
  x <- my_as_numeric(x)
  
  if (is.numeric(x)) {
    numeric_summary(x)
  } else {
    level_summary(x, variable, df)
  }
}

if (isTRUE(getOption('knitr.in.progress'))) {
  file_format <- rmarkdown::all_output_formats(knitr::current_input())
} else {
  file_format <- ""
}

print_hux <- function(x) {
  if ("html_document" %in% file_format) {
    print_html(x)
  } else if ("pdf_document" %in% file_format) {
    print_latex(x)
  } else if ("word_document" %in% file_format) {
    print_md(x)
  } else {
    print(x)
  }
}

mcmc_pairwise_diffs <- function(chains) {
  # Calculate the pairwise differences between columns
  # Adapted from http://stackoverflow.com/a/28187446/120898
  pair_names <- outer(colnames(chains), colnames(chains),
                      paste, sep = " − ")
  pairs_to_omit <- which(lower.tri(pair_names, diag = TRUE))
  
  mcmc_diffs <- outer(1:ncol(chains), 1:ncol(chains),
                      function(x, y) chains[,x] - chains[,y]) %>% 
    magrittr::set_colnames(pair_names) %>% 
    select(-pairs_to_omit)

  return(mcmc_diffs)
}

tidy_diffs <- function(diffs_pairs) {
  diffs_pairs %>% 
    gather(pair, value) %>% 
    group_by(pair) %>% 
    summarise(mean = mean(value),
              median = median(value),
              q2.5 = quantile(value, probs = 0.025),
              q5 = quantile(value, probs = 0.05),
              q25 = quantile(value, probs = 0.25),
              q75 = quantile(value, probs = 0.75),
              q95 = quantile(value, probs = 0.95),
              q97.5 = quantile(value, probs = 0.975),
              p.greater0 = mean(value > 0),
              p.less0 = mean(value < 0))
}
```

# Overview of data

## Balance of experimental conditions

```{r check-conditions, results="asis"}
results %>% count(crackdown, issue, funding) %>% 
  janitor::adorn_totals(where = "row") %>% 
  pandoc.table()
```

## Descriptive statistics table

```{r tbl-descriptive-statistics, results="asis", warning=FALSE}
vars_to_summarize <- tribble(
  ~variable, ~clean_name,
  "donate_likely", "Likelihood of donation",
  "donate_likely_bin", "Likelihood of donation (binary)",
  "amount_donate", "Amount hypothetically donated ($)",
  "favor_humanitarian", "Prior favorability towards humanitarian NGOs",
  "favor_humanitarian_bin", "Prior favorability towards humanitarian NGOs (binary)",
  "favor_human_rights", "Prior favorability towards human rights NGOs",
  "favor_human_rights_bin", "Prior favorability towards human rights NGOs (binary)",
  "favor_development", "Prior favorability towards development NGOs",
  "favor_development_bin", "Prior favorability towards development NGOs (binary)",
  "give_charity", "Frequency of charitable donations",
  "volunteer", "Volunteered in past 12 months",
  "political_knowledge", "Frequency of following public affairs",
  "ideology", "Political views",
  "education", "Education",
  "religiosity", "Frequency of attending religious services",
  "gender", "Gender",
  "income", "Income",
  "age", "Age",
  "check1", "Attention check 1",
  "check2", "Attention check 2"
)

results_summary_stats <- results %>% 
  select(one_of(vars_to_summarize$variable)) %>% 
  gather(variable, value) %>% 
  group_by(variable) %>% 
  nest() %>% 
  mutate(N = data %>% map_int(~ nrow(.)),
         Details = map2_chr(.x = data, .y = variable, ~ my_summary(.x$value, .y, results))) %>% 
  left_join(vars_to_summarize, by = "variable") %>% 
  mutate(variable = factor(variable, levels = vars_to_summarize$variable, ordered = TRUE)) %>% 
  arrange(variable) %>% 
  select(-data, -variable) %>% 
  select(Variable = clean_name, everything())

results_summary_stats %>% knitr::kable()
```

## Average likelihood and amount donated across conditions

```{r tbl-results-conditions, results="asis"}
conditions_summary <- bind_rows(group_by(results, crackdown, issue, funding) %>% nest(),
                                group_by(results, crackdown, issue) %>% nest(),
                                group_by(results, crackdown) %>% nest(),
                                results %>% nest()) %>% 
  arrange(crackdown, issue, funding) %>% 
  mutate(summary = data %>%
           map(~ summarize(., pct_likely = table(donate_likely_bin)[["Likely"]] /
                             length(donate_likely_bin),
                           mean_donation = mean(amount_donate, na.rm = TRUE),
                           sd_donation = sd(amount_donate, na.rm = TRUE),
                           N = nrow(.)))) %>% 
  unnest(summary) %>% select(-data)

conditions_summary_clean <- conditions_summary %>% 
  mutate(funding = ifelse(is.na(funding) & !is.na(issue) , "*Total*", as.character(funding)),
         issue = ifelse(is.na(issue) & !is.na(crackdown), "*Total*", as.character(issue)),
         crackdown = ifelse(is.na(crackdown), "*Total*", as.character(crackdown))) %>% 
  group_by(crackdown) %>% 
  mutate(issue = replace(issue, duplicated(issue), NA)) %>% 
  ungroup() %>% 
  mutate(crackdown = replace(crackdown, duplicated(crackdown), NA)) %>% 
  mutate(pct_likely = percent(pct_likely)) %>% 
  rename(`Crackdown condition` = crackdown, `Issue condition` = issue,
         `Funding condition` = funding, `% likely to donate` = pct_likely,
         `Amount donated (mean)` = mean_donation, `Amount donated (sd)` = sd_donation)

conditions_summary_clean %>% pandoc.table()
```

\

# Visualize important variables

## Prior favorability towards NGOs

```{r fig-ngo-favorability, fig.width=7, fig.height=4}
ngo_favorability_raw <- results %>%
  select(favor_humanitarian, favor_human_rights, favor_development) %>% 
  gather(variable, value) %>% 
  count(variable, value) %>% 
  left_join(vars_to_summarize, by = "variable") %>% 
  left_join(favorability_cols_5, by = "value") %>% 
  mutate(clean_name = str_replace(clean_name, "towards", "towards\n")) %>% 
  mutate(value = factor(value, levels = levels(results$favor_humanitarian), ordered = TRUE),
         clean_name = fct_inorder(clean_name, ordered = TRUE)) %>%
  arrange(value) %>% 
  mutate(color = fct_inorder(color, ordered = TRUE))

ngo_favorability_high <- ngo_favorability_raw %>% 
  filter(!str_detect(value, "nfav")) %>% 
  mutate(n = ifelse(value == "Neutral", n / 2, n),
         n_plot = n,
         value = fct_rev(value), color = fct_rev(color))

ngo_favorability_low <- ngo_favorability_raw %>% 
  filter(str_detect(value, "nfav") | value == "Neutral") %>% 
  mutate(n = ifelse(value == "Neutral", n / 2, n),
         n_plot = -n)

ggplot(mapping = aes(x = n_plot, y = clean_name, fill = color)) +
  geom_barh(data = ngo_favorability_high, stat = "identity") +
  geom_barh(data = ngo_favorability_low, stat = "identity") +
  geom_vline(xintercept = 0, color = "black") +
  scale_x_continuous(labels = abs) +
  scale_fill_identity(labels = levels(ngo_favorability_raw$value), 
                      breaks = levels(ngo_favorability_raw$color),
                      guide = "legend", name = NULL) +
  labs(x = NULL, y = NULL) +
  theme_ngos() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank())
```

\

# Interpreting interactions in models

Ordinarily, people use ANOVA to analyze 3-way, 2 × 2 × 2 factorial designs, [like this](https://mypages.valdosta.edu/mwhatley/3600/2x2x2.htm). A more flexible ([yet identical!](https://www.theanalysisfactor.com/why-anova-and-linear-regression-are-the-same-analysis/)) way to do this is to use a regular regression model with interaction terms for each of the conditions, like so (here we use three, since we can use simper models to get averages for the larger umbrella groups, like just crackdowns and crackdown + issue):

- Model 1: 

    $$
    y = \beta_0 + \beta_1 \text{Crackdown}
    $$

- Model 2: 

    $$
    \begin{aligned}
    y =& \beta_0 + \beta_1 \text{Crackdown} + \beta_2 \text{Issue } + \\
    & \beta_3 \text{Crackdown} \times \text{Issue}
    \end{aligned}
    $$

- Model 3: 

    $$
    \begin{aligned}
    y =& \beta_0 + \beta_1 \text{Crackdown} + \beta_2 \text{Issue} + \beta_3 \text{Funding } + \\
    & \beta_4 \text{Crackdown} \times \text{Issue } + \\
    & \beta_5 \text{Crackdown} \times \text{Funding } + \\
    & \beta_6 \text{Issue} \times \text{Funding } + \\
    & \beta_7 \text{Crackdown} \times \text{Issue} \times \text{Funding}
    \end{aligned}
    $$

Adding different combinations of the coefficients provides the average values for each combination of factors, which corresponds to the average likelihood and amount donated table above. 

```{r interaction-interpretation, results="asis"}
model1 <- "1"
model2 <- "2"
model3 <- "3"

interpretation <- tribble(
  ~Model, ~`Coefficients to add together`,
  model3, "Intercept",
  model3, "Intercept + Funding",
  model2, "Intercept",
  model3, "Intercept + Issue",
  model3, "Intercept + Issue + Funding + (Issue × Funding)",
  model2, "Intercept + Issue",
  model1, "Intercept",
  model3, "Intercept + Crackdown",
  model3, "Intercept + Crackdown + Funding + (Crackdown × Funding)",
  model2, "Intercept + Crackdown",
  model3, "Intercept + Crackdown + Issue + (Crackdown × Issue)",
  model3, "Intercept + Crackdown + Issue + Funding + (Crackdown × Issue) + (Crackdown × Funding) + (Issue × Funding) + (Crackdown × Issue × Funding)",
  model2, "Intercept + Crackdown + Issue + (Crackdown × Issue)",
  model1, "Intercept + Crackdown"
)

conditions_summary_clean %>% 
  select(1:3) %>% 
  slice(-n()) %>% 
  bind_cols(interpretation) %>% 
  pandoc.table()
```

\

# Amount donated

## Models

```{r build-models-amount, warning=FALSE, message=FALSE, cache=TRUE}
# Basic interaction models
m_amount_c <- stan_glm(amount_donate ~ crackdown,
                       data = results, family = gaussian(),
                       prior = cauchy(location = 0, scale = 2.5),
                       prior_intercept = cauchy(location = 0, scale = 10),
                       chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED)

m_amount_ci <- update(m_amount_c, . ~ . + issue + crackdown * issue)

m_amount_cif <- update(m_amount_c, . ~ . + 
                         issue + funding + crackdown * issue + crackdown * funding + 
                         issue * funding + crackdown * issue * funding)

# Interaction models with extra controls
m_amount_c_full <- update(m_amount_c, . ~ . + 
                            favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin +
                            give_charity_3 + volunteer + political_knowledge_bin +
                            ideology_bin + education_bin + religiosity_bin +
                            income_bin + age_bin)

m_amount_ci_full <- update(m_amount_ci, . ~ . + 
                             favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin +
                             give_charity_3 + volunteer + political_knowledge_bin +
                             ideology_bin + education_bin + religiosity_bin +
                             income_bin + age_bin)

m_amount_cif_full <-update(m_amount_cif, . ~ . + 
                             favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin +
                             give_charity_3 + volunteer + political_knowledge_bin +
                             ideology_bin + education_bin + religiosity_bin +
                             income_bin + age_bin)
```

```{r tbl-models-amount, results="asis"}
huxreg(m_amount_c, m_amount_ci, m_amount_cif, 
       m_amount_c_full, m_amount_ci_full, m_amount_cif_full,
       coefs = clean_coefs_named,
       statistics = model_stats_bayes,
       stars = NULL) %>% 
  print_hux()
```

## Coefficient plot

```{r models-plot}
coefs_amount <- data_frame(model_name = c("Basic model", "Full model"),
                           model = list(m_amount_cif,
                                        m_amount_cif_full)) %>% 
  mutate(tidy = model %>% map(~ tidyMCMC(., conf.int = TRUE, conf.level = 0.9,
                                         conf.method = "HPDinterval"))) %>% 
  unnest(tidy) %>% 
  left_join(clean_coefs, by = "term") %>% 
  filter(term_clean != "Intercept")

ggplot(coefs_amount, aes(x = estimate, y = fct_rev(term_clean_fct), 
                         color = fct_rev(model_name))) +
  geom_pointrangeh(aes(xmin = conf.high, xmax = conf.low), 
                   position = position_dodgev(height = 0.5)) +
  geom_vline(xintercept = 0) + 
  scale_color_manual(values = c(ngo_red, ngo_blue), 
                     guide = guide_legend(title = NULL, reverse = TRUE)) +
  labs(x = "Posterior median estimate + 90% credible interval", y = NULL) +
  theme_ngos() +
  theme(panel.grid.major.y = element_blank())
```

## Predicted medians

The Stan people really really don't like `posterior_linepred()`, since it throws away a lot of the uncertainty that comes from actually getting a posterior distribution (like, [they didn't even want to invent it, and then when they did they wanted to hide it](https://github.com/stan-dev/rstanarm/issues/85), and it has a big warning in the documentation). But this approach here mirrors using `predict()` to combine all the coefficients and intercept terms in a regular frequentist linear model and it's probably appropriate for this situation because all the coefficients are actually linked together behind the scenes and create group mean estimates. If I use the full force of `posterior_predict()`, I add more uncertainty with each added coefficient (so in a 2×2×2 version, the 8th condition is actually the sum of all 8 coefficients, which means it gets 8 levels of uncertainity, which is probably excessive). But we do it both ways too, just to be on the safe side.

```{r amount-median-c}
newdata_conditions_c <- results %>% expand(nesting(crackdown))

chains_fitted_c <- posterior_linpred(m_amount_c, 
                                     newdata = newdata_conditions_c)

# posterior_fit <- posterior_predict(m_amount_c, 
#                                    newdata = newdata_conditions_c,
#                                    draws = 50, seed = BAYES_SEED)

coef_summary_c <- newdata_conditions_c %>% 
  bind_cols(tidyMCMC(as.mcmc(chains_fitted_c), estimate.method = "median",
                     conf.int = TRUE, conf.level = 0.9, conf.method = "HPDinterval"))

# newdata <- newdata_conditions %>% 
#   bind_cols(tidyMCMC(as.mcmc(posterior_fit), estimate.method = "median",
#                      conf.int = TRUE, conf.level = 0.9, conf.method = "HPDinterval"))

plot_amount_c <- ggplot(coef_summary_c, aes(y = estimate, x = crackdown)) + 
  # geom_point(data = results, aes(y = amount_donate, x = crackdown),
  #            color = "grey50", size = 0.5, alpha = 0.25) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), color = ngo_green) + 
  scale_y_continuous(labels = dollar) +
  labs(x = NULL, y = "Median amount donated") +
  # coord_cartesian(ylim = c(0, 100)) +
  theme_ngos() +
  theme(panel.grid.major.x = element_blank())
```

```{r amount-median-ci}
newdata_conditions_ci <- results %>% expand(nesting(crackdown, issue))

chains_fitted_ci <- posterior_linpred(m_amount_ci, 
                                      newdata = newdata_conditions_ci)

coef_summary_ci <- newdata_conditions_ci %>% 
  bind_cols(tidyMCMC(as.mcmc(chains_fitted_ci), estimate.method = "median",
                     conf.int = TRUE, conf.level = 0.9, conf.method = "HPDinterval"))

plot_amount_ci <- ggplot(coef_summary_ci, aes(y = estimate, x = crackdown)) + 
  # geom_point(data = results, aes(y = amount_donate, x = crackdown),
  #            color = "grey50", size = 0.5, alpha = 0.25) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), color = ngo_blue) + 
  scale_y_continuous(labels = dollar) +
  labs(x = NULL, y = "Median amount donated") +
  # coord_cartesian(ylim = c(0, 100)) +
  theme_ngos() +
  theme(panel.grid.major.x = element_blank(),
        strip.text = element_text(margin = margin(5, 0, 2, 0, "pt"))) +
  facet_wrap(~ issue)
```

```{r amount-median-cif}
newdata_conditions_cif <- results %>% expand(nesting(crackdown, issue, funding))

chains_fitted_cif <- posterior_linpred(m_amount_cif, 
                                       newdata = newdata_conditions_cif)

coef_summary_cif <- newdata_conditions_cif %>% 
  bind_cols(tidyMCMC(as.mcmc(chains_fitted_cif), estimate.method = "median",
                     conf.int = TRUE, conf.level = 0.9, conf.method = "HPDinterval"))

plot_amount_cif <- ggplot(coef_summary_cif, aes(y = estimate, x = crackdown)) + 
  # geom_point(data = results, aes(y = amount_donate, x = crackdown),
  #            color = "grey50", size = 0.5, alpha = 0.5) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), color = ngo_red) +
  scale_y_continuous(labels = dollar) +
  labs(x = NULL, y = "Median amount donated") +
  theme_ngos() +
  theme(panel.grid.major.x = element_blank(),
        strip.text = element_text(margin = margin(5, 0, 2, 0, "pt"))) +
  facet_wrap(~ issue + funding)
```

```{r plot-all-amount-medians, fig.width=8, fig.height=6}
((plot_amount_c + 
   labs(title = "Median donation in control and crackdown groups,\nconditioned by other experimental groups",
        subtitle = "90% credible intervals shown around each point")) / 
   plot_amount_ci) | plot_amount_cif
```


## Differences in medians

```{r amount-diffs-c}
diffs_coef_pairs_c <- chains_fitted_c %>% 
  as_data_frame() %>% 
  magrittr::set_colnames(levels(newdata_conditions_c$crackdown)) %>% 
  mcmc_pairwise_diffs()

diffs_coef_pairs_detail_c <- tidy_diffs(diffs_coef_pairs_c)

pairs_plot_data_c <- diffs_coef_pairs_c %>%
  gather(pair, value) %>%
  mutate(pair1 = pair) %>%
  separate(pair1, into = c("group1", "group2"), sep = " − ") %>%
  mutate(pair = ifelse(nchar(pair) > 25,
                       str_replace(pair, "−", "−\n"),
                       pair))
  
plot_diffs_c <- ggplot() + 
  geom_density(data = pairs_plot_data_c, aes(x = value),
               fill = ngo_green, colour = NA, alpha = 0.4) + 
  geom_segment(data = diffs_coef_pairs_detail_c, 
               aes(x = q5, xend = q95, y = 0, yend = 0),
               size = 3) +
  geom_vline(data = diffs_coef_pairs_detail_c, aes(xintercept = median), size = 0.25) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  guides(fill = FALSE, color = FALSE) +
  labs(x = "Difference in medians") +
  theme_ngos(density = TRUE) +
  facet_wrap(~ pair)
```

```{r amount-diffs-ci}
# Nest each fitted chain into a single row that corresponds to each newdata_condition
chains_nested_ci <- chains_fitted_ci %>% 
  as_data_frame() %>% 
  mutate(id = 1:n()) %>% 
  gather(condition, value, -id) %>% 
  group_by(condition) %>% 
  nest()

# Add the fitted chains to the conditions, spread the main crackdown condition
# into two columns, then nest everything by issue
all_chains_ci <- bind_cols(newdata_conditions_ci, chains_nested_ci) %>% 
  unnest(data) %>% 
  select(-condition) %>% 
  group_by(issue) %>% 
  spread(crackdown, value) %>% 
  select(-id) %>% 
  nest()

# All the pairwise differences in a single data frame, grouped by issue
pairs_conditions_ci <- all_chains_ci %>% 
  mutate(diffs_coef_pairs = data %>% map(~ mcmc_pairwise_diffs(.)),
         diffs_coef_pairs_detail = diffs_coef_pairs %>% map(~ tidy_diffs(.)))

# Extract coefficient details and plot data
diffs_coef_pairs_detail_ci <- pairs_conditions_ci %>% 
  unnest(diffs_coef_pairs_detail) %>% 
  select(-data, -diffs_coef_pairs)

pairs_plot_data_ci <- pairs_conditions_ci %>% 
  select(issue, diffs_coef_pairs) %>% 
  unnest(diffs_coef_pairs) %>%
  gather(pair, value, -issue) %>%
  mutate(pair1 = pair) %>%
  separate(pair1, into = c("group1", "group2"), sep = " − ") %>%
  mutate(pair = ifelse(nchar(pair) > 25,
                       str_replace(pair, "−", "−\n"),
                       pair))

plot_diffs_ci <- ggplot() + 
  geom_density(data = pairs_plot_data_ci, aes(x = value),
               fill = ngo_blue, colour = NA, alpha = 0.4) + 
  geom_segment(data = diffs_coef_pairs_detail_ci, 
               aes(x = q5, xend = q95, y = 0, yend = 0),
               size = 3) +
  geom_vline(data = diffs_coef_pairs_detail_ci, aes(xintercept = median), size = 0.25) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  guides(fill = FALSE, color = FALSE) +
  labs(x = "Difference in medians") +
  theme_ngos(density = TRUE) +
  facet_wrap(~ issue + pair)
```

```{r amount-diffs-cif}
# Nest each fitted chain into a single row that corresponds to each newdata_condition
chains_nested_cif <- chains_fitted_cif %>% 
  as_data_frame() %>% 
  mutate(id = 1:n()) %>% 
  gather(condition, value, -id) %>% 
  group_by(condition) %>% 
  nest()

# Add the fitted chains to the conditions, spread the main crackdown condition
# into two columns, then nest everything by issue
all_chains_cif <- bind_cols(newdata_conditions_cif, chains_nested_cif) %>% 
  unnest(data) %>% 
  select(-condition) %>% 
  group_by(issue, funding) %>% 
  spread(crackdown, value) %>% 
  select(-id) %>% 
  nest()

# All the pairwise differences in a single data frame, grouped by issue
pairs_conditions_cif <- all_chains_cif %>% 
  mutate(diffs_coef_pairs = data %>% map(~ mcmc_pairwise_diffs(.)),
         diffs_coef_pairs_detail = diffs_coef_pairs %>% map(~ tidy_diffs(.)))

# Extract coefficient details and plot data
diffs_coef_pairs_detail_cif <- pairs_conditions_cif %>% 
  unnest(diffs_coef_pairs_detail) %>% 
  select(-data, -diffs_coef_pairs)

pairs_plot_data_cif <- pairs_conditions_cif %>% 
  select(issue, funding, diffs_coef_pairs) %>% 
  unnest(diffs_coef_pairs) %>%
  gather(pair, value, -issue, -funding) %>%
  mutate(pair1 = pair) %>%
  separate(pair1, into = c("group1", "group2"), sep = " − ") %>%
  mutate(pair = ifelse(nchar(pair) > 25,
                       str_replace(pair, "−", "−\n"),
                       pair))

plot_diffs_cif <- ggplot() + 
  geom_density(data = pairs_plot_data_cif, aes(x = value),
               fill = ngo_red, colour = NA, alpha = 0.4) + 
  geom_segment(data = diffs_coef_pairs_detail_cif, 
               aes(x = q5, xend = q95, y = 0, yend = 0),
               size = 3) +
  geom_vline(data = diffs_coef_pairs_detail_cif, aes(xintercept = median), size = 0.25) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  guides(fill = FALSE, color = FALSE) +
  labs(x = "Difference in medians") +
  theme_ngos(density = TRUE) +
  facet_wrap(~ issue + funding + pair)
```

```{r plot-all-amount-diffs, fig.width=8, fig.height=6}
((plot_diffs_c + 
   labs(title = "Differences in median amount donated in control and crackdown groups,\nconditioned by other experimental groups",
        subtitle = "90% credible intervals shown in black. Solid vertical line = median; dotted vertical line = 0")) / 
   plot_diffs_ci) | plot_diffs_cif
```

```{r tbl-all-amount-diffs, results="asis"}
bind_rows(diffs_coef_pairs_detail_c,
          diffs_coef_pairs_detail_ci,
          diffs_coef_pairs_detail_cif) %>% 
  select(Issue = issue, Funding = funding, 
         `No crackdown − crackdown (median)` = median, 
         `P(m > 0)` = p.greater0, `P(m < 0)` = p.less0) %>% 
  pandoc.table(missing = "—", 
               caption = 'Median difference between amounts donated in "no crackdown" (control) and "crackdown" conditions')
```

\

# Likelihood of donation

## Models

```{r build-models-likely, warning=FALSE, message=FALSE, cache=TRUE}
# Basic interaction models
# Weakly informative student t priors, since these coefficients are log-odds
# See https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations#prior-for-the-regression-coefficients-in-logistic-regression-non-sparse-case and https://arxiv.org/abs/1507.07170
m_likely_c <- stan_glm(donate_likely_bin ~ crackdown,
                       data = results, family = binomial(link = "logit"),
                       prior = student_t(3, 0, 2.5),
                       prior_intercept = student_t(3, 0, 10),
                       chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED)

m_likely_ci <- update(m_likely_c, . ~ . + issue + crackdown * issue)

m_likely_cif <- update(m_likely_c, . ~ . + 
                         issue + funding + crackdown * issue + crackdown * funding + 
                         issue * funding + crackdown * issue * funding)

# Interaction models with extra controls
m_likely_c_full <- update(m_likely_c, . ~ . + 
                            favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin +
                            give_charity_3 + volunteer + political_knowledge_bin +
                            ideology_bin + education_bin + religiosity_bin +
                            income_bin + age_bin)

m_likely_ci_full <- update(m_likely_ci, . ~ . + 
                             favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin +
                             give_charity_3 + volunteer + political_knowledge_bin +
                             ideology_bin + education_bin + religiosity_bin +
                             income_bin + age_bin)

m_likely_cif_full <-update(m_likely_cif, . ~ . + 
                             favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin +
                             give_charity_3 + volunteer + political_knowledge_bin +
                             ideology_bin + education_bin + religiosity_bin +
                             income_bin + age_bin)
```

```{r tbl-models-likely, results="asis"}
huxreg(m_likely_c, m_likely_ci, m_likely_cif, 
       m_likely_c_full, m_likely_ci_full, m_likely_cif_full,
       coefs = clean_coefs_named,
       statistics = model_stats_bayes,
       stars = NULL) %>% 
  print_hux()
```

## Coefficient plot

## Predicted medians

```{r likely-median-c}
newdata_conditions_c <- results %>% expand(nesting(crackdown))

# transform = TRUE does the same thing as plogis(as.matrix(m_likely_c))
chains_fitted_likely_c <- posterior_linpred(m_likely_c, 
                                            newdata = newdata_conditions_c, 
                                            transform = TRUE)

coef_summary_likely_c <- newdata_conditions_c %>% 
  bind_cols(tidyMCMC(as.mcmc(chains_fitted_likely_c), estimate.method = "median",
                     conf.int = TRUE, conf.level = 0.9, conf.method = "HPDinterval"))

plot_likely_c <- ggplot(coef_summary_likely_c, aes(y = estimate, x = crackdown)) + 
  # geom_point(data = results, aes(y = amount_donate, x = crackdown),
  #            color = "grey50", size = 0.5, alpha = 0.25) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), color = ngo_green) + 
  scale_y_continuous(labels = percent) +
  labs(x = NULL, y = "Probability of donating") +
  # coord_cartesian(ylim = c(0, 100)) +
  theme_ngos() +
  theme(panel.grid.major.x = element_blank())
```

```{r likely-median-ci}
newdata_conditions_ci <- results %>% expand(nesting(crackdown, issue))

chains_fitted_likely_ci <- posterior_linpred(m_likely_ci, 
                                             newdata = newdata_conditions_ci,
                                             transform = TRUE)

coef_summary_likely_ci <- newdata_conditions_ci %>% 
  bind_cols(tidyMCMC(as.mcmc(chains_fitted_likely_ci), estimate.method = "median",
                     conf.int = TRUE, conf.level = 0.9, conf.method = "HPDinterval"))

plot_likely_ci <- ggplot(coef_summary_likely_ci, aes(y = estimate, x = crackdown)) + 
  # geom_point(data = results, aes(y = amount_donate, x = crackdown),
  #            color = "grey50", size = 0.5, alpha = 0.25) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), color = ngo_blue) + 
  scale_y_continuous(labels = percent) +
  labs(x = NULL, y = "Probability of donating") +
  # coord_cartesian(ylim = c(0, 100)) +
  theme_ngos() +
  theme(panel.grid.major.x = element_blank(),
        strip.text = element_text(margin = margin(5, 0, 2, 0, "pt"))) +
  facet_wrap(~ issue)
```

```{r likely-median-cif}
newdata_conditions_cif <- results %>% expand(nesting(crackdown, issue, funding))

chains_fitted_likely_cif <- posterior_linpred(m_likely_cif, 
                                              newdata = newdata_conditions_cif,
                                              transform = TRUE)

coef_summary_likely_cif <- newdata_conditions_cif %>% 
  bind_cols(tidyMCMC(as.mcmc(chains_fitted_likely_cif), estimate.method = "median",
                     conf.int = TRUE, conf.level = 0.9, conf.method = "HPDinterval"))

plot_likely_cif <- ggplot(coef_summary_likely_cif, aes(y = estimate, x = crackdown)) + 
  # geom_point(data = results, aes(y = amount_donate, x = crackdown),
  #            color = "grey50", size = 0.5, alpha = 0.5) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), color = ngo_red) +
  scale_y_continuous(labels = percent) +
  labs(x = NULL, y = "Probability of donating") +
  theme_ngos() +
  theme(panel.grid.major.x = element_blank(),
        strip.text = element_text(margin = margin(5, 0, 2, 0, "pt"))) +
  facet_wrap(~ issue + funding)
```

```{r plot-all-likely-medians, fig.width=8, fig.height=6}
((plot_likely_c + 
   labs(title = "Median likelihood of donation in control and crackdown groups,\nconditioned by other experimental groups",
        subtitle = "90% credible intervals shown around each point")) / 
   plot_likely_ci) | plot_likely_cif
```


## Differences in medians

```{r likely-diffs-c}
diffs_coef_likely_pairs_c <- chains_fitted_likely_c %>% 
  as_data_frame() %>% 
  magrittr::set_colnames(levels(newdata_conditions_c$crackdown)) %>% 
  mcmc_pairwise_diffs()

diffs_coef_likely_pairs_detail_c <- tidy_diffs(diffs_coef_likely_pairs_c)

pairs_likely_plot_data_c <- diffs_coef_likely_pairs_c %>%
  gather(pair, value) %>%
  mutate(pair1 = pair) %>%
  separate(pair1, into = c("group1", "group2"), sep = " − ") %>%
  mutate(pair = ifelse(nchar(pair) > 25,
                       str_replace(pair, "−", "−\n"),
                       pair))
  
plot_diffs_likely_c <- ggplot() + 
  geom_density(data = pairs_likely_plot_data_c, aes(x = value),
               fill = ngo_green, colour = NA, alpha = 0.4) + 
  geom_segment(data = diffs_coef_likely_pairs_detail_c, 
               aes(x = q5, xend = q95, y = 0, yend = 0),
               size = 3) +
  geom_vline(data = diffs_coef_likely_pairs_detail_c, 
             aes(xintercept = median), size = 0.25) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  guides(fill = FALSE, color = FALSE) +
  scale_x_continuous(labels = percent) +
  labs(x = "Difference in medians") +
  theme_ngos(density = TRUE) +
  facet_wrap(~ pair)
```

```{r likely-diffs-ci}
# Nest each fitted chain into a single row that corresponds to each newdata_condition
chains_nested_likely_ci <- chains_fitted_likely_ci %>% 
  as_data_frame() %>% 
  mutate(id = 1:n()) %>% 
  gather(condition, value, -id) %>% 
  group_by(condition) %>% 
  nest()

# Add the fitted chains to the conditions, spread the main crackdown condition
# into two columns, then nest everything by issue
all_chains_likely_ci <- bind_cols(newdata_conditions_ci, 
                                  chains_nested_likely_ci) %>% 
  unnest(data) %>% 
  select(-condition) %>% 
  group_by(issue) %>% 
  spread(crackdown, value) %>% 
  select(-id) %>% 
  nest()

# All the pairwise differences in a single data frame, grouped by issue
pairs_likely_conditions_ci <- all_chains_likely_ci %>% 
  mutate(diffs_coef_pairs = data %>% map(~ mcmc_pairwise_diffs(.)),
         diffs_coef_pairs_detail = diffs_coef_pairs %>% map(~ tidy_diffs(.)))

# Extract coefficient details and plot data
diffs_coef_likely_pairs_detail_ci <- pairs_likely_conditions_ci %>% 
  unnest(diffs_coef_pairs_detail) %>% 
  select(-data, -diffs_coef_pairs)

pairs_likely_plot_data_ci <- pairs_likely_conditions_ci %>% 
  select(issue, diffs_coef_pairs) %>% 
  unnest(diffs_coef_pairs) %>%
  gather(pair, value, -issue) %>%
  mutate(pair1 = pair) %>%
  separate(pair1, into = c("group1", "group2"), sep = " − ") %>%
  mutate(pair = ifelse(nchar(pair) > 25,
                       str_replace(pair, "−", "−\n"),
                       pair))

plot_diffs_likely_ci <- ggplot() + 
  geom_density(data = pairs_likely_plot_data_ci, aes(x = value),
               fill = ngo_blue, colour = NA, alpha = 0.4) + 
  geom_segment(data = diffs_coef_likely_pairs_detail_ci, 
               aes(x = q5, xend = q95, y = 0, yend = 0),
               size = 3) +
  geom_vline(data = diffs_coef_likely_pairs_detail_ci, 
             aes(xintercept = median), size = 0.25) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  guides(fill = FALSE, color = FALSE) +
  scale_x_continuous(labels = percent) +
  labs(x = "Difference in medians") +
  theme_ngos(density = TRUE) +
  facet_wrap(~ issue + pair)
```

```{r likely-diffs-cif}
# Nest each fitted chain into a single row that corresponds to each newdata_condition
chains_nested_likely_cif <- chains_fitted_likely_cif %>% 
  as_data_frame() %>% 
  mutate(id = 1:n()) %>% 
  gather(condition, value, -id) %>% 
  group_by(condition) %>% 
  nest()

# Add the fitted chains to the conditions, spread the main crackdown condition
# into two columns, then nest everything by issue
all_chains_likely_cif <- bind_cols(newdata_conditions_cif, 
                                   chains_nested_likely_cif) %>% 
  unnest(data) %>% 
  select(-condition) %>% 
  group_by(issue, funding) %>% 
  spread(crackdown, value) %>% 
  select(-id) %>% 
  nest()

# All the pairwise differences in a single data frame, grouped by issue
pairs_likely_conditions_cif <- all_chains_likely_cif %>% 
  mutate(diffs_coef_pairs = data %>% map(~ mcmc_pairwise_diffs(.)),
         diffs_coef_pairs_detail = diffs_coef_pairs %>% map(~ tidy_diffs(.)))

# Extract coefficient details and plot data
diffs_coef_likely_pairs_detail_cif <- pairs_likely_conditions_cif %>% 
  unnest(diffs_coef_pairs_detail) %>% 
  select(-data, -diffs_coef_pairs)

pairs_likely_plot_data_cif <- pairs_likely_conditions_cif %>% 
  select(issue, funding, diffs_coef_pairs) %>% 
  unnest(diffs_coef_pairs) %>%
  gather(pair, value, -issue, -funding) %>%
  mutate(pair1 = pair) %>%
  separate(pair1, into = c("group1", "group2"), sep = " − ") %>%
  mutate(pair = ifelse(nchar(pair) > 25,
                       str_replace(pair, "−", "−\n"),
                       pair))

plot_diffs_likely_cif <- ggplot() + 
  geom_density(data = pairs_likely_plot_data_cif, aes(x = value),
               fill = ngo_red, colour = NA, alpha = 0.4) + 
  geom_segment(data = diffs_coef_likely_pairs_detail_cif, 
               aes(x = q5, xend = q95, y = 0, yend = 0),
               size = 3) +
  geom_vline(data = diffs_coef_likely_pairs_detail_cif, 
             aes(xintercept = median), size = 0.25) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  guides(fill = FALSE, color = FALSE) +
  scale_x_continuous(labels = percent) +
  labs(x = "Difference in medians") +
  theme_ngos(density = TRUE) +
  facet_wrap(~ issue + funding + pair)
```

```{r plot-all-likely-diffs, fig.width=8, fig.height=6}
((plot_diffs_likely_c + 
   labs(title = "Differences in donation likelihood in control and crackdown groups,\nconditioned by other experimental groups",
        subtitle = "90% credible intervals shown in black. Solid vertical line = median; dotted vertical line = 0")) / 
   plot_diffs_likely_ci) | plot_diffs_likely_cif
```

```{r tbl-all-likely-diffs, results="asis"}
bind_rows(diffs_coef_likely_pairs_detail_c,
          diffs_coef_likely_pairs_detail_ci,
          diffs_coef_likely_pairs_detail_cif) %>% 
  select(Issue = issue, Funding = funding, 
         `No crackdown − crackdown (median)` = median, 
         `P(m > 0)` = p.greater0, `P(m < 0)` = p.less0) %>% 
  pandoc.table(missing = "—", 
               caption = 'Median difference between likelihood to donate in "no crackdown" (control) and "crackdown" conditions')
```
