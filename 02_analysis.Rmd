---
title: "Results"
author: "Andrew Heiss and Suparna Chaudhry"
date: "Last run: `r format(Sys.time(), '%B %e, %Y')`"
output: 
  html_document:
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r load-libraries-data, warning=FALSE, message=FALSE}
library(tidyverse)
library(rstanarm)
library(broom)
library(coda)
library(ggstance)
library(pander)
library(scales)
library(skimr)
library(janitor)
library(huxtable)
library(here)

source(file.path(here(), "lib", "graphics.R"))
source(file.path(here(), "lib", "pander_options.R"))
source(file.path(here(), "lib", "modeling.R"))

# Load data
results <- readRDS(file.path(here(), "data", "results_clean.rds"))


# Helpful functions
safe_mean <- function(x, ...) suppressWarnings(mean(as.numeric(x), ...))
safe_sd <- function(x, ...) suppressWarnings(sd(as.numeric(x), ...))

my_as_numeric <- function(x) {
  is_num <- suppressWarnings(!any(is.na(as.numeric(x))))
  
  if (is_num) {
    as.numeric(x)
  } else {
    x
  }
}

level_summary <- function(x, variable, df = results) {
  variable <- as.character(variable)
  if (is.factor(df[[variable]])) {
    x_levels <- levels(df[[variable]])
  } else {
    x_levels <- unique(df[[variable]])
  }
  
  data_frame(x) %>% 
    count(x) %>%
    mutate(pct = n / sum(n),
           fancy = paste0(x, " (", n, "; ", percent(pct), ")"),
           x = factor(x, levels = x_levels, ordered = TRUE)) %>% 
    arrange(x) %>% 
    pull(fancy) %>% 
    paste(collapse = " | ")
}

numeric_summary <- function(x) {
  paste0("Mean: ", round(mean(x, na.rm = TRUE), 2), 
         " | Std. Dev.: ", round(sd(x, na.rm = TRUE), 2),
         " | ", inline_hist(x))
}

my_summary <- function(x, variable, df) {
  x <- my_as_numeric(x)
  
  if (is.numeric(x)) {
    numeric_summary(x)
  } else {
    level_summary(x, variable, df)
  }
}

if (isTRUE(getOption('knitr.in.progress'))) {
  file_format <- rmarkdown::all_output_formats(knitr::current_input())
} else {
  file_format <- ""
}

print_hux <- function(x) {
  if ("html_document" %in% file_format) {
    print_html(x)
  } else if ("pdf_document" %in% file_format) {
    print_latex(x)
  } else if ("word_document" %in% file_format) {
    print_md(x)
  } else {
    print(x)
  }
}
```

# Overview of data

## Balance of experimental conditions

```{r check-conditions, results="asis"}
results %>% count(crackdown, issue, funding) %>% 
  janitor::adorn_totals(where = "row") %>% 
  pandoc.table()
```

## Descriptive statistics table

```{r tbl-descriptive-statistics, results="asis", warning=FALSE}
vars_to_summarize <- tribble(
  ~variable, ~clean_name,
  "donate_likely", "Likelihood of donation",
  "donate_likely_bin", "Likelihood of donation (binary)",
  "amount_donate", "Amount hypothetically donated ($)",
  "favor_humanitarian", "Prior favorability towards humanitarian NGOs",
  "favor_humanitarian_bin", "Prior favorability towards humanitarian NGOs (binary)",
  "favor_human_rights", "Prior favorability towards human rights NGOs",
  "favor_human_rights_bin", "Prior favorability towards human rights NGOs (binary)",
  "favor_development", "Prior favorability towards development NGOs",
  "favor_development_bin", "Prior favorability towards development NGOs (binary)",
  "give_charity", "Frequency of charitable donations",
  "volunteer", "Volunteered in past 12 months",
  "political_knowledge", "Frequency of following public affairs",
  "ideology", "Political views",
  "education", "Education",
  "religiosity", "Frequency of attending religious services",
  "gender", "Gender",
  "income", "Income",
  "age", "Age",
  "check1", "Attention check 1",
  "check2", "Attention check 2"
)

results_summary_stats <- results %>% 
  select(one_of(vars_to_summarize$variable)) %>% 
  gather(variable, value) %>% 
  group_by(variable) %>% 
  nest() %>% 
  mutate(N = data %>% map_int(~ nrow(.)),
         Details = map2_chr(.x = data, .y = variable, ~ my_summary(.x$value, .y, results))) %>% 
  left_join(vars_to_summarize, by = "variable") %>% 
  mutate(variable = factor(variable, levels = vars_to_summarize$variable, ordered = TRUE)) %>% 
  arrange(variable) %>% 
  select(-data, -variable) %>% 
  select(Variable = clean_name, everything())

results_summary_stats %>% knitr::kable()
```


## Visualize important variables

```{r fig-ngo-favorability, fig.width=7, fig.height=4}
ngo_favorability_raw <- results %>%
  select(favor_humanitarian, favor_human_rights, favor_development) %>% 
  gather(variable, value) %>% 
  count(variable, value) %>% 
  left_join(vars_to_summarize, by = "variable") %>% 
  left_join(favorability_cols_5, by = "value") %>% 
  mutate(clean_name = str_replace(clean_name, "towards", "towards\n")) %>% 
  mutate(value = factor(value, levels = levels(results$favor_humanitarian), ordered = TRUE),
         clean_name = fct_inorder(clean_name, ordered = TRUE)) %>%
  arrange(value) %>% 
  mutate(color = fct_inorder(color, ordered = TRUE))

ngo_favorability_high <- ngo_favorability_raw %>% 
  filter(!str_detect(value, "nfav")) %>% 
  mutate(n = ifelse(value == "Neutral", n / 2, n),
         n_plot = n,
         value = fct_rev(value), color = fct_rev(color))

ngo_favorability_low <- ngo_favorability_raw %>% 
  filter(str_detect(value, "nfav") | value == "Neutral") %>% 
  mutate(n = ifelse(value == "Neutral", n / 2, n),
         n_plot = -n)

ggplot(mapping = aes(x = n_plot, y = clean_name, fill = color)) +
  geom_barh(data = ngo_favorability_high, stat = "identity") +
  geom_barh(data = ngo_favorability_low, stat = "identity") +
  geom_vline(xintercept = 0, color = "black") +
  scale_x_continuous(labels = abs) +
  scale_fill_identity(labels = levels(ngo_favorability_raw$value), 
                      breaks = levels(ngo_favorability_raw$color),
                      guide = "legend", name = NULL) +
  labs(x = NULL, y = NULL) +
  theme_ngos() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank())
```

## Average likelihood and amount donated across conditions

```{r tbl-results-conditions, results="asis"}
conditions_summary <- bind_rows(group_by(results, crackdown, issue, funding) %>% nest(),
                                group_by(results, crackdown, issue) %>% nest(),
                                group_by(results, crackdown) %>% nest(),
                                results %>% nest()) %>% 
  arrange(crackdown, issue, funding) %>% 
  mutate(summary = data %>%
           map(~ summarize(., pct_likely = table(donate_likely_bin)[["Likely"]] /
                             length(donate_likely_bin),
                           mean_donation = mean(amount_donate, na.rm = TRUE),
                           sd_donation = sd(amount_donate, na.rm = TRUE),
                           N = nrow(.)))) %>% 
  unnest(summary) %>% select(-data)

conditions_summary_clean <- conditions_summary %>% 
  mutate(funding = ifelse(is.na(funding) & !is.na(issue) , "*Total*", as.character(funding)),
         issue = ifelse(is.na(issue) & !is.na(crackdown), "*Total*", as.character(issue)),
         crackdown = ifelse(is.na(crackdown), "*Total*", as.character(crackdown))) %>% 
  group_by(crackdown) %>% 
  mutate(issue = replace(issue, duplicated(issue), NA)) %>% 
  ungroup() %>% 
  mutate(crackdown = replace(crackdown, duplicated(crackdown), NA)) %>% 
  mutate(pct_likely = percent(pct_likely)) %>% 
  rename(`Crackdown condition` = crackdown, `Issue condition` = issue,
         `Funding condition` = funding, `% likely to donate` = pct_likely,
         `Amount donated (mean)` = mean_donation, `Amount donated (sd)` = sd_donation)

conditions_summary_clean %>% pandoc.table()
```

\

# Interpreting interactions in models

Ordinarily, people use ANOVA to analyze 3-way, 2 × 2 × 2 factorial designs, [like this](https://mypages.valdosta.edu/mwhatley/3600/2x2x2.htm). A more flexible ([yet identical!](https://www.theanalysisfactor.com/why-anova-and-linear-regression-are-the-same-analysis/)) way to do this is to use a regular regression model with interaction terms for each of the conditions, like so (here we use three, since we can use simper models to get averages for the larger umbrella groups, like just crackdowns and crackdown + issue):

- Model 1: 

    $$
    y = \beta_0 + \beta_1 \text{Crackdown}
    $$

- Model 2: 

    $$
    \begin{aligned}
    y =& \beta_0 + \beta_1 \text{Crackdown} + \beta_2 \text{Issue } + \\
    & \beta_3 \text{Crackdown} \times \text{Issue}
    \end{aligned}
    $$

- Model 3: 

    $$
    \begin{aligned}
    y =& \beta_0 + \beta_1 \text{Crackdown} + \beta_2 \text{Issue} + \beta_3 \text{Funding } + \\
    & \beta_4 \text{Crackdown} \times \text{Issue } + \\
    & \beta_5 \text{Crackdown} \times \text{Funding } + \\
    & \beta_6 \text{Issue} \times \text{Funding } + \\
    & \beta_7 \text{Crackdown} \times \text{Issue} \times \text{Funding}
    \end{aligned}
    $$

Adding different combinations of the coefficients provides the average values for each combination of factors, which corresponds to the average likelihood and amount donated table above. 

```{r interaction-interpretation, results="asis"}
model1 <- "1"
model2 <- "2"
model3 <- "3"

interpretation <- tribble(
  ~Model, ~`Coefficients to add together`,
  model3, "Intercept",
  model3, "Intercept + Funding",
  model2, "Intercept",
  model3, "Intercept + Issue",
  model3, "Intercept + Issue + Funding + (Issue × Funding)",
  model2, "Intercept + Issue",
  model1, "Intercept",
  model3, "Intercept + Crackdown",
  model3, "Intercept + Crackdown + Funding + (Crackdown × Funding)",
  model2, "Intercept + Crackdown",
  model3, "Intercept + Crackdown + Issue + (Crackdown × Issue)",
  model3, "Intercept + Crackdown + Issue + Funding + (Crackdown × Issue) + (Crackdown × Funding) + (Issue × Funding) + (Crackdown × Issue × Funding)",
  model2, "Intercept + Crackdown + Issue + (Crackdown × Issue)",
  model1, "Intercept + Crackdown"
)

conditions_summary_clean %>% 
  select(1:3) %>% 
  slice(-n()) %>% 
  bind_cols(interpretation) %>% 
  pandoc.table()
```


# Amount donated

## Models

```{r build-models-amount, warning=FALSE, message=FALSE, cache=TRUE}
# Basic interaction models
m_amount_crackdown <- 
  stan_glm(amount_donate ~ crackdown,
           data = results, family = gaussian(),
           prior = student_t(df = 1, location = 0),
           prior_intercept = student_t(df = 1, location = 0),
           chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED)

m_amount_crackdown_issue <- 
  update(m_amount_crackdown, . ~ . + issue + crackdown * issue)

m_amount_crackdown_issue_funding <- 
  update(m_amount_crackdown, . ~ . + 
           issue + funding + crackdown * issue + crackdown * funding + 
           issue * funding + crackdown * issue * funding)

# Interaction models with extra controls
m_amount_crackdown_full <- 
  update(m_amount_crackdown, . ~ . + 
           favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin)

m_amount_crackdown_issue_full <- 
  update(m_amount_crackdown_issue, . ~ . + 
           favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin)

m_amount_crackdown_issue_funding_full <- 
  update(m_amount_crackdown_issue_funding, . ~ . + 
           favor_humanitarian_bin + favor_human_rights_bin + favor_development_bin)

# m_propensity_small <- stan_glm(donate_likely_bin ~ crackdown + issue + funding + 
#                                  crackdown * issue + crackdown * funding + issue * funding +
#                                  crackdown * issue * funding,
#                                data = results, family = binomial(link = "logit"),
#                                prior = student_t(df = 1, location = 0),
#                                prior_intercept = student_t(df = 1, location = 0),
#                                chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED)
```

```{r models-table, results="asis"}
huxreg(m_amount_crackdown, m_amount_crackdown_issue, 
       m_amount_crackdown_issue_funding, 
       m_amount_crackdown_full, m_amount_crackdown_issue_full, 
       m_amount_crackdown_issue_funding_full,
       coefs = clean_coefs_named,
       statistics = model_stats_bayes,
       stars = NULL) %>% 
  print_hux()
```

## Coefficient plot

```{r models-plot}
coefs_amount <- data_frame(model_name = c("Basic model", "Full model"),
                           model = list(m_amount_crackdown_issue_funding,
                                        m_amount_crackdown_issue_funding_full)) %>% 
  mutate(tidy = model %>% map(~ tidyMCMC(., conf.int = TRUE, conf.level = 0.9,
                                         conf.method = "HPDinterval"))) %>% 
  unnest(tidy) %>% 
  left_join(clean_coefs, by = "term") %>% 
  filter(term_clean != "Intercept")

ggplot(coefs_amount, aes(x = estimate, y = fct_rev(term_clean_fct), 
                         color = fct_rev(model_name))) +
  geom_pointrangeh(aes(xmin = conf.high, xmax = conf.low), 
                   position = position_dodgev(height = 0.5)) +
  geom_vline(xintercept = 0) + 
  scale_color_manual(values = c(ngo_red, ngo_blue), 
                     guide = guide_legend(title = NULL, reverse = TRUE)) +
  labs(x = "Posterior median estimate + 90% credible interval", y = NULL) +
  theme_ngos() +
  theme(panel.grid.major.y = element_blank())
```

## Predicted medians

```{r models-predicted}
newdata_conditions <- results %>% 
  expand(nesting(crackdown, issue, funding))

posterior_fit <- posterior_predict(m_amount_crackdown_issue_funding, 
                                   newdata = newdata_conditions,
                                   re.form = NA, draws = 50, seed = BAYES_SEED)

nested_draws <- posterior_fit %>% 
  as_data_frame() %>% 
  gather(id, value) %>% 
  group_by(id) %>%
  nest()

all_posterior_draws <- bind_cols(newdata_conditions, nested_draws) %>% unnest(data)

newdata <- newdata_conditions %>% 
  bind_cols(tidyMCMC(as.mcmc(posterior_fit), conf.int = TRUE, 
                     conf.level = 0.9, conf.method = "HPDinterval"))

ggplot(newdata, aes(y = estimate, x = funding)) + 
  geom_point(data = all_posterior_draws, aes(y = value, x = funding), 
             color = "grey50", size = 1.5, alpha = 0.25) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) + 
  scale_y_continuous(labels = dollar) +
  labs(x = "Funding", y = "Average amount donated") +
  coord_cartesian(ylim = c(0, 100)) +
  theme_ngos() +
  facet_wrap(~ crackdown + issue)
```
